## 版本包批量部署解决方案(发布平台)

### 1 简介

发布平台是一个进行版本包安装、升级、回滚等操作的平台，主要用于运维人员发布程序版本包，下面将从两个方面介绍版本发布的解决方案。

### 2 版本发布

其实，版本发布跟我们手动去安装一个程序类似，将版本包拷贝到远程服务器上，然后进行配置、编译、启动等过程。但是，在一个发布平台里面，要将这些过程自动化，就需要考虑许多情况，将用户可能进行的操作都考虑进来：

(1) 将版本包上传到远程服务器

(2) 修改版本包的配置

(3) 安装之前可能要执行一些操作，如将某个文件拷贝到另一个目录中

(4) 编译

(5) 启动程序

(6) 检查是否启动成功

(7) 安装之后可能要执行一些操作，如删除某些临时文件

上面的(2)可以通过`变量替换`解决，(3)、(4)、(5)、(7)可以通过配置文件解决。

### 3 版本包的上传

将一个版本包上传到远程服务器有两种方案：scp和rsync。其实两种方案比较类似，只是rsync有限速，而scp没有。另外，如果使用rsync的话，建议使用rsync的模块方式，该方式的传输比不使用模块方式更加稳定。

### 4 变量替换

当配置文件中的某个值可能会根据安装环境变化，并且，需要大量的进行版本部署时，可以将该变量提取出来，变成该包的一个变量配置。

由于需要进行变量替换，就需要在安装时将包拷贝到临时目录，在临时目录中对配置文件中的变量进行替换。另一方面，不同IP的变量可能是不一样的，因此，还需要对每个IP都生成一份版本包的拷贝。基于这个问题，可以将一个版本包分成两个部分：不需要进行替换的部分和需要进行替换的部分。进行变量替换之前，将整个版本包拷贝到临时目录中，再对每个IP创建一个目录，并将需要进行变量替换的部分拷贝到IP目录下，当对某个IP要发布的版本包进行变量替换时，只需要替换IP所对应的目录中的文件。

变量替换还有另外一个用处，这次变量替换的值可以保存起来(数据库)，下次进行替换时，可以根据版本包的信息找到上次替换的值，因为变量替换这个操作有局部性，因此，一般来说，第一次替换之后，该版本包之后的安装都可以采用上次替换的值，这在构建一个自动化发布平台时可以减少用户的输入。

### 5 配置文件

如上所述，版本包的安装有许多可变部分，需要将这些操作自动化，让发布平台能够在需要的时候自动进行该操作。

在本文描述的解决方案中，每个版本包中都含有一个XML文件：init.xml文件，该文件中的配置分为两种类型：基础信息和配置信息。

基础信息是该版本包的描述信息，让安装脚本可以从该配置文件获取足够的信息，例如，包名，版本号，安装路径等等。

配置信息就是操作的自动化配置，例如，程序的启动方式，程序的停止方式，安装前操作，安装后操作，添加的crontab。这些操作都包含在XML的标签中。

因此，版本包的安装就是执行init.xml文件中的配置，或者是一段shell脚本，或者是需要添加的crontab，或者是需要监控的进程等等，可以按照自己的需要添加相关的信息，只要安装程序能够解析即可。通常需要包含下面几个部分：

* 安装(升级)前执行
* 安装(升级)后执行
* 版本包启动逻辑
* 版本包停止逻辑
* crontab

上面几个部分基本可以满足大部分的需求。

### 6 远程操作

版本发布需要系统提供两个功能：

* 版本包的上传
* 远程执行发布脚本

版本包上传采用前面所说的scp或者rsync，当然，还可以采用与SVN同步的方式。而远程执行发布脚本可以采用ssh+expect脚本，它提供了与远程服务器的一种应答交互方式，当然，也支持远程执行命令的操作。

### 7 版本安装

根据前面的介绍，版本包的安装可以分成下面三个过程：

(1) 拷贝版本包到临时目录，并进行变量替换
(2) 将版本包上传到远程服务器
(3) 执行init.xml文件中的配置

上面的(2)和(3)都可以根据自己的需求选择不同的方案，而(1)就需要考虑下面两个问题：

* 一个包可以配置多个变量，每个机器上的这些变量都不一样吗？其实，这些变量是有差别的，可能有些变量在所有机器上都一样，而有些变量在某些机器上才一样，因此，可以对这些变量进行分级。
* 由于有了变量替换，版本包分成了两个部分，因此，在进行版本包上传时有两个策略：(1) 在上传之前将两个部分进行合并，然后只上传一个包；(2) 分两次上传到目标机器，在目标机器上进行合并。

### 8 版本升级

安装和升级过程类似，但是，也有一些区别：

(1) 版本包分为三个部分：升级前的版本包、升级前后的差异包、需要进行变量替换的部分。因此，在进行传输之前需要比对当前安装版本和要升级的目标版本的版本包，获取两个版本的差异，而在版本包上传时，只上传有修改的文件和需要进行变量替换的文件，然后，在目标机器上，将有修改的文件和进行变量替换的文件拷贝到当前安装版本包中。

(2) 安装过程默认版本包第一次安装，因此，只需要考虑启动，而且，在添加crontab时，直接添加即可。而升级时，需要考虑停止逻辑，而且，如果使用了crontab，在停止时，需要卸载crontab，在启动时，再添加crontab。

(3) 升级时，将版本包的两个部分上传到远程服务器后，还需要比较当前版本和发布平台预期的安装前版本是否一致，如果不一致，不允许进行升级操作。

### 9 部署过程的流程化

经过上面的介绍，整个部署过程可以流程化：

#### 9.1 安装过程的流程化

* 选择要安装的版本和IP
* 对版本包中的配置文件进行变量替换
* 确认安装选项(安装后是否启动)
* 用户点击"安装"就进入到后台安装流程

* 将版本包上传到远程服务器，执行安装脚本
* 载入版本包的基础信息
* 进入验证阶段：验证用户，验证当前安装环境
* 执行安装前操作
* 拷贝文件
* 执行安装后操作
* 创建版本包的MD5列表
* 验证安装是否成功

#### 9.2 升级过程的流程化

* 选择要升级的IP和目标版本
* 计算当前安装版本和目标版本的差异
* 进行变量替换
* 确认升级选项(升级后是否重启)
* 用户点击"升级"就进入到后台升级流程

* 将版本包上传到远程服务器，执行安装脚本
* 载入版本包的基础信息
* 进入验证阶段：验证用户，验证当前安装环境
* 进入文件验证阶段
* 执行升级前操作
* 拷贝要升级的文件
* 执行升级后操作
* 更新版本包的MD5列表
* 验证升级是否成功

#### 10 最后一个问题：升级的文件验证

升级时，为了保证文件被"完整"的升级到目标版本，需要有两个保证：

* 保证文件被正确的上传到目标服务器
* 保证目标机器的文件没有被恶意篡改，如果篡改了，需要给用户提示

这类文件完整性问题采用MD5解决，在上传之前计算好升级前版本的文件的MD5(假设是A)和升级后的MD5(假设是B)，上传到目标服务器后：

* 计算目标机器的上传的文件的MD5，与B比较，如果不一致，说明文件上传失败
* 在安装时，目标机器的原版本包已经计算好了MD5，此时，可以将该MD5与当前已安装版本的文件的MD5比较，如果不一致，则有可能篡改了
* 计算当前已安装版本的文件的MD5，与A比较，如果不一致，则很有可能被篡改了